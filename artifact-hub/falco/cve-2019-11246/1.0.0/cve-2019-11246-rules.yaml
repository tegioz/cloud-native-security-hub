- macro: safe_kubectl_version
  condition: (jevt.value[/userAgent] startswith "kubectl/v1.19" or
    jevt.value[/userAgent] startswith "kubectl/v1.18" or
    jevt.value[/userAgent] startswith "kubectl/v1.17" or
    jevt.value[/userAgent] startswith "kubectl/v1.16" or
    jevt.value[/userAgent] startswith "kubectl/v1.15" or
    jevt.value[/userAgent] startswith "kubectl/v1.14.3" or
    jevt.value[/userAgent] startswith "kubectl/v1.14.2" or
    jevt.value[/userAgent] startswith "kubectl/v1.13.7" or
    jevt.value[/userAgent] startswith "kubectl/v1.13.6" or
    jevt.value[/userAgent] startswith "kubectl/v1.12.9")

# CVE-2019-11246
# Run kubectl version --client and if it does not say client version 1.12.9, 1.13.6, or 1.14.2 or newer,  you are running a vulnerable version.
- rule: K8s Vulnerable Kubectl Copy
  desc: Detect any attempt vulnerable kubectl copy in pod
  condition: kevt_started and pod_subresource and kcreate and
    ka.target.subresource = "exec" and ka.uri.param[command] = "tar" and
    not safe_kubectl_version
  output: Vulnerable kubectl copy detected (user=%ka.user.name pod=%ka.target.name ns=%ka.target.namespace action=%ka.target.subresource command=%ka.uri.param[command] userAgent=%jevt.value[/userAgent])
  priority: WARNING
  source: k8s_audit
  tags: [k8s]
