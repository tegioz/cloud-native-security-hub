#
# Auto-generated set of falco rules for k8s_dns containers
# Generated at 2018-05-23 15:00:05 UTC
#

# By default, the autogenerated rules include rules that attempt to
# restrict the set of system calls that can be performed by
# applications. However, we know that these rules are fairly FP-prone,
# so they are disabled by default. If you'd like to enable them,
# either change or override this macro's condition to "evt.num >= 0".
- macro: k8s_dns_consider_syscalls
  condition: (evt.num < 0)

# These policies are limited to containers, specifically those where
# the container image name starts with "k8s_dns"
- macro: app_k8s_dns
  condition: container and container.image contains "k8s_dns"

# Considering any inbound network connection suspect
- rule: Unexpected inbound connection k8s_dns
  desc: Detect any inbound connection arriving at k8s_dns
  condition: inbound and evt.rawres >= 0 and app_k8s_dns
  output: Unexpected inbound connection arriving at k8s_dns (command=%proc.cmdline pid=%proc.pid connection=%fd.name user=%user.name %container.info image=%container.image)
  priority: NOTICE

# Considering any outbound networking suspect
- rule: Unexpected outbound connection k8s_dns
  desc: Detect any outbound connection originating from k8s_dns
  condition: outbound and app_k8s_dns
  output: Unexpected outbound connection originating at k8s_dns (command=%proc.cmdline pid=%proc.pid connection=%fd.name user=%user.name %container.info image=%container.image)
  priority: NOTICE

# Restricting listening ports to selected set

- list: k8s_dns_allowed_inbound_ports_tcp
  items: [53]

- rule: Unexpected inbound tcp connection k8s_dns
  desc: Detect inbound traffic to k8s_dns using tcp on a port outside of expected set
  condition: inbound and evt.rawres >= 0 and not fd.sport in (k8s_dns_allowed_inbound_ports_tcp) and app_k8s_dns
  output: Inbound network connection to k8s_dns on unexpected port (command=%proc.cmdline pid=%proc.pid connection=%fd.name sport=%fd.sport user=%user.name %container.info image=%container.image)
  priority: NOTICE
- list: k8s_dns_allowed_inbound_ports_udp
  items: [53]

- rule: Unexpected inbound udp connection k8s_dns
  desc: Detect inbound traffic to k8s_dns using udp on a port outside of expected set
  condition: inbound and evt.rawres >= 0 and not fd.sport in (k8s_dns_allowed_inbound_ports_udp) and app_k8s_dns
  output: Inbound network connection to k8s_dns on unexpected port (command=%proc.cmdline pid=%proc.pid connection=%fd.name sport=%fd.sport user=%user.name %container.info image=%container.image)
  priority: NOTICE

# Restricting spawned processes to selected set

- list: k8s_dns_allowed_processes
  items: ["/dnsmasq-nanny", "/usr/sbin/dnsmasq", "dnsmasq"]

- rule: Unexpected spawned process k8s_dns
  desc: Detect a process started in a k8s_dns container outside of an expected set
  condition: spawned_process and not proc.name in (k8s_dns_allowed_processes) and app_k8s_dns
  output: Unexpected process spawned in k8s_dns container (command=%proc.cmdline pid=%proc.pid user=%user.name %container.info image=%container.image)
  priority: NOTICE

# Restricting files read or written to specific set

- list: k8s_dns_allowed_file_prefixes_readonly
  items: ["/etc/k8s/dns"]

- rule: Unexpected file access readonly for k8s_dns
  desc: Detect an attempt to access a file readonly other than below an expected list of directories
  condition: (open_read and evt.is_open_write=false) and not fd.name pmatch (k8s_dns_allowed_file_prefixes_readonly) and app_k8s_dns
  output: Unexpected file accessed readonly for k8s_dns (command=%proc.cmdline pid=%proc.pid file=%fd.name %container.info image=%container.image)
  priority: NOTICE

- list: k8s_dns_allowed_file_prefixes_readwrite
  items: ["/dev"]

- rule: Unexpected file access readwrite for k8s_dns
  desc: Detect an attempt to access a file readwrite other than below an expected list of directories
  condition: (open_write) and not fd.name pmatch (k8s_dns_allowed_file_prefixes_readwrite) and app_k8s_dns
  output: Unexpected file accessed readwrite for k8s_dns (command=%proc.cmdline pid=%proc.pid file=%fd.name %container.info image=%container.image)
  priority: NOTICE
